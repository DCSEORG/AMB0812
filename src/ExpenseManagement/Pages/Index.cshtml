@page
@model IndexModel
@{
    ViewData["Title"] = "Dashboard";
}

<div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="mb-0">Expense Dashboard</h2>
    <a asp-page="/Expenses/Create" class="btn btn-primary">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="me-1" viewBox="0 0 16 16">
            <path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4z"/>
        </svg>
        New Expense
    </a>
</div>

<!-- Stats Cards -->
<div class="row g-4 mb-4">
    <div class="col-md-3">
        <div class="stat-card">
            <p>Total Expenses</p>
            <h3>@Model.Stats.TotalExpenses</h3>
        </div>
    </div>
    <div class="col-md-3">
        <div class="stat-card" style="border-left-color: #FFC107;">
            <p>Pending Approvals</p>
            <h3>@Model.Stats.PendingApprovals</h3>
        </div>
    </div>
    <div class="col-md-3">
        <div class="stat-card" style="border-left-color: #4CAF50;">
            <p>Approved Amount</p>
            <h3>Â£@Model.Stats.ApprovedAmountGBP.ToString("N2")</h3>
        </div>
    </div>
    <div class="col-md-3">
        <div class="stat-card" style="border-left-color: #17A2B8;">
            <p>Approved Count</p>
            <h3>@Model.Stats.ApprovedCount</h3>
        </div>
    </div>
</div>

<!-- Recent Expenses -->
<div class="card">
    <div class="card-body">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="card-title mb-0">Recent Expenses</h5>
            <a asp-page="/Expenses/Index" class="btn btn-outline-secondary btn-sm">View All</a>
        </div>
        
        <div class="table-responsive">
            <table class="table">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Employee</th>
                        <th>Category</th>
                        <th>Amount</th>
                        <th>Status</th>
                        <th>Description</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var expense in Model.RecentExpenses)
                    {
                        <tr>
                            <td>@expense.ExpenseDate.ToString("dd MMM yyyy")</td>
                            <td>@expense.UserName</td>
                            <td>@expense.CategoryName</td>
                            <td>Â£@expense.AmountGBP.ToString("N2")</td>
                            <td>
                                <span class="status-badge status-@expense.StatusName.ToLower()">@expense.StatusName</span>
                            </td>
                            <td>@(expense.Description ?? "-")</td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Chat Section -->
<div class="card mt-4">
    <div class="card-body">
        <h5 class="card-title mb-3">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="me-2" viewBox="0 0 16 16">
                <path d="M5 8a1 1 0 1 1-2 0 1 1 0 0 1 2 0zm4 0a1 1 0 1 1-2 0 1 1 0 0 1 2 0zm3 1a1 1 0 1 0 0-2 1 1 0 0 0 0 2z"/>
                <path d="m2.165 15.803.02-.004c1.83-.363 2.948-.842 3.468-1.105A9.06 9.06 0 0 0 8 15c4.418 0 8-3.134 8-7s-3.582-7-8-7-8 3.134-8 7c0 1.76.743 3.37 1.97 4.6a10.437 10.437 0 0 1-.524 2.318l-.003.011a10.722 10.722 0 0 1-.244.637c-.079.186.074.394.273.362a21.673 21.673 0 0 0 .693-.125zm.8-3.108a1 1 0 0 0-.287-.801C1.618 10.83 1 9.468 1 8c0-3.192 3.004-6 7-6s7 2.808 7 6c0 3.193-3.004 6-7 6a8.06 8.06 0 0 1-2.088-.272 1 1 0 0 0-.711.074c-.387.196-1.24.57-2.634.893a10.97 10.97 0 0 0 .398-2z"/>
            </svg>
            AI Assistant
        </h5>
        <div id="chat-container" style="height: 300px; overflow-y: auto; border: 1px solid #e9ecef; border-radius: 8px; padding: 1rem; background: #f8f9fa; margin-bottom: 1rem;">
            <div id="chat-messages">
                <div class="chat-message assistant">
                    <div class="message-content" style="background: white; padding: 0.75rem 1rem; border-radius: 12px; margin-bottom: 0.5rem; display: inline-block; max-width: 80%;">
                        ðŸ‘‹ Hello! I'm your expense assistant. Ask me about your expenses, create new ones, or get insights about your spending.
                    </div>
                </div>
            </div>
        </div>
        <div class="input-group">
            <input type="text" id="chat-input" class="form-control" placeholder="Ask about your expenses..." />
            <button class="btn btn-primary" type="button" id="chat-send">Send</button>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        const chatMessages = document.getElementById('chat-messages');
        const chatInput = document.getElementById('chat-input');
        const chatSend = document.getElementById('chat-send');
        let chatHistory = [];

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function formatMessage(text) {
            let escaped = escapeHtml(text);
            
            // Bold text
            escaped = escaped.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            
            // Handle numbered lists
            const lines = escaped.split('\n');
            let inOrderedList = false;
            let formatted = [];
            
            for (let line of lines) {
                if (/^\d+\.\s/.test(line.trim())) {
                    if (!inOrderedList) {
                        formatted.push('<ol>');
                        inOrderedList = true;
                    }
                    formatted.push('<li>' + line.replace(/^\d+\.\s/, '') + '</li>');
                } else if (/^[-*]\s/.test(line.trim())) {
                    if (inOrderedList) {
                        formatted.push('</ol>');
                        inOrderedList = false;
                    }
                    formatted.push('<li>' + line.replace(/^[-*]\s/, '') + '</li>');
                } else {
                    if (inOrderedList) {
                        formatted.push('</ol>');
                        inOrderedList = false;
                    }
                    formatted.push(line);
                }
            }
            
            if (inOrderedList) {
                formatted.push('</ol>');
            }
            
            return formatted.join('<br>');
        }

        function addMessage(content, isUser) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `chat-message ${isUser ? 'user' : 'assistant'}`;
            messageDiv.style.textAlign = isUser ? 'right' : 'left';
            
            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';
            contentDiv.style.cssText = `background: ${isUser ? '#5B6EE1' : 'white'}; color: ${isUser ? 'white' : '#333'}; padding: 0.75rem 1rem; border-radius: 12px; margin-bottom: 0.5rem; display: inline-block; max-width: 80%; text-align: left;`;
            contentDiv.innerHTML = formatMessage(content);
            
            messageDiv.appendChild(contentDiv);
            chatMessages.appendChild(messageDiv);
            chatMessages.parentElement.scrollTop = chatMessages.parentElement.scrollHeight;
        }

        async function sendMessage() {
            const message = chatInput.value.trim();
            if (!message) return;
            
            addMessage(message, true);
            chatHistory.push({ role: 'user', content: message });
            chatInput.value = '';
            chatSend.disabled = true;
            
            try {
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message, history: chatHistory.slice(-10) })
                });
                
                const data = await response.json();
                addMessage(data.response, false);
                chatHistory.push({ role: 'assistant', content: data.response });
            } catch (error) {
                addMessage('Sorry, I encountered an error. Please try again.', false);
            }
            
            chatSend.disabled = false;
        }

        chatSend.addEventListener('click', sendMessage);
        chatInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendMessage();
        });
    </script>
}
